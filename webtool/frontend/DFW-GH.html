<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DWF-GH</title>

    <!-- 引入标准bootstrap文件和jQuery文件 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>

    <!-- 引入自定义的css和js -->
    <link rel="stylesheet" type="text/css" href="css/main.css">
	
	<!-- 接口 -->
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script language="javascript">
		function getInputs(){
			
			var pointdata = [];
			for (var i = 0; i < points.length; i++) {
				pointdata.push(points[i].x, 500-points[i].y);
			}
			var reduce_rate=document.getElementById("reduce_rate").value;
			var tolerance_of_edge_length=document.getElementById("tolerance_of_edge_length").value;
			var length_constraint_maltiplier=document.getElementById("length_constraint_maltiplier").value;
			var boundary_constraint_magnitude=document.getElementById("boundary_constraint_magnitude").value;
			var perp_steps=document.getElementById("perp_steps").value;
			var minumum_radius=document.getElementById("minumum_radius").value;
			var maximum_radius=document.getElementById("maximum_radius").value;
			value_inputs = {
				"canvas_points": pointdata,
				"reduce_rate": reduce_rate,
				"tolerance_of_edge_length": tolerance_of_edge_length,
				"length_constraint_maltiplier": length_constraint_maltiplier,
				"boundary_constraint_magnitude": boundary_constraint_magnitude,
				"perp_steps": perp_steps,
				"minumum_radius": minumum_radius,
				"maximum_radius": maximum_radius
			};
			axios({
				// headers:{'Cache-Control':'no-cache'},
				method: 'post',
				url: 'http://127.0.0.1:8888/ghHere/ep/predict/?delay=900&interval=15',
				data: value_inputs
			}).then(function (response){
				console.log(response.data);
				// let fp = response.data.fp
			}).catch(function(err){
				console.log(err)
			});
			// alert(value_inputs);
			
			// location.reload();
			console.log(value_inputs);

		}
	</script>
</head>

<body>
    <div id="container" style="width:500px; height:auto; float:left; display:inline">
	    <canvas id="canvas" width="500" height="500" style="border: 3px solid black"></canvas>
    </div>
	<div id="container" style="width:510px; height:500px; float:left; display:inline; padding-left:20px;">
	    <div class="form-group" id="l"></div>
		    <div class="col-sm-4"></div>
			    
			    <span class="input-group-addon" style="font-size:20px; white-space:nowrap;">Reduce Rate (0~1)</span>
				<input type="range" min="0" max="1" step="0.01" name="reduce_rate" id="reduce_rate" style="width:400px; height:20px;" oninput="change_reduce_rate()" onchange="change_reduce_rate()"/>
			    <span id="value_reduce_rate" style="font-size:20px">0</span>
				<script type='text/javascript'>
					function change_reduce_rate() {
					    var value_reduce_rate = document.getElementById('reduce_rate').value;
						document.getElementById('value_reduce_rate').innerHTML = value_reduce_rate;
					}
				</script>
				<!-- <input type="text" class="form-control" name="reduce_rate" id="reduce_rate" style="width:400px; height:30px;"> -->
		    	
				<span class="input-group-addon" style="font-size:20px; white-space:nowrap;">Tolerance of Edge Length (0~1)</span>
				<input type="range" min="0" max="1" step="0.01" name="tolerance_of_edge_length" id="tolerance_of_edge_length" style="width:400px; height:20px;" oninput="change_tolerance_of_edge_length()" onchange="change_tolerance_of_edge_length()"/>
			    <span id="value_tolerance_of_edge_length" style="font-size:20px">0</span>
				<script type='text/javascript'>
					function change_tolerance_of_edge_length() {
					    var value_tolerance_of_edge_length = document.getElementById('tolerance_of_edge_length').value;
						document.getElementById('value_tolerance_of_edge_length').innerHTML = value_tolerance_of_edge_length;
					}
				</script>
			    <!-- <input type="text" class="form-control" name="tolerance_of_edge_length" id="tolerance_of_edge_length" style="width:400px; height:30px;"> -->
				
				<span class="input-group-addon" style="font-size:20px; white-space:nowrap;">Length Constraint Maltiplier (0~2)</span>
				<input type="range" min="0" max="2" step="0.01" name="length_constraint_maltiplier" id="length_constraint_maltiplier" style="width:400px; height:20px;" oninput="change_length_constraint_maltiplier()" onchange="change_length_constraint_maltiplier()"/>
			    <span id="value_length_constraint_maltiplier" style="font-size:20px">0</span>
				<script type='text/javascript'>
					function change_length_constraint_maltiplier() {
					    var value_length_constraint_maltiplier = document.getElementById('length_constraint_maltiplier').value;
						document.getElementById('value_length_constraint_maltiplier').innerHTML = value_length_constraint_maltiplier;
					}
				</script>
			    <!-- <input type="text" class="form-control" name="length_constraint_maltiplier" id="length_constraint_maltiplier" style="width:400px; height:30px;"> -->

				<span class="input-group-addon" style="font-size:20px; white-space:nowrap;">Boundary Constraint Magnitude (0~10)</span>
				<input type="range" min="0" max="10" step="0.01" name="boundary_constraint_magnitude" id="boundary_constraint_magnitude" style="width:400px; height:20px;" oninput="change_boundary_constraint_magnitude()" onchange="change_boundary_constraint_magnitude()"/>
			    <span id="value_boundary_constraint_magnitude" style="font-size:20px">0</span>
				<script type='text/javascript'>
					function change_boundary_constraint_magnitude() {
					    var value_boundary_constraint_magnitude = document.getElementById('boundary_constraint_magnitude').value;
						document.getElementById('value_boundary_constraint_magnitude').innerHTML = value_boundary_constraint_magnitude;
					}
				</script>
			    <!-- <input type="text" class="form-control" name="boundary_constraint_magnitude" id="boundary_constraint_magnitude" style="width:400px; height:30px;"> -->

				<span class="input-group-addon" style="font-size:20px; white-space:nowrap;">Perp Steps (0~30000)</span>
				<input type="range" min="0" max="30000" step="1" name="perp_steps" id="perp_steps" style="width:400px; height:20px;" oninput="change_perp_steps()" onchange="change_perp_steps()"/>
			    <span id="value_perp_steps" style="font-size:20px">0</span>
				<script type='text/javascript'>
					function change_perp_steps() {
					    var value_perp_steps = document.getElementById('perp_steps').value;
						document.getElementById('value_perp_steps').innerHTML = value_perp_steps;
					}
				</script>
			    <!-- <input type="text" class="form-control" name="perp_steps" id="perp_steps" style="width:400px; height:30px;"> -->

				<span class="input-group-addon" style="font-size:20px; white-space:nowrap;">Minumum Radius (0~100)</span>
				<input type="range" min="0" max="100" step="0.01" name="minumum_radius" id="minumum_radius" style="width:400px; height:20px;" oninput="change_minumum_radius()" onchange="change_minumum_radius()"/>
			    <span id="value_minumum_radius" style="font-size:20px">0</span>
				<script type='text/javascript'>
					function change_minumum_radius() {
					    var value_minumum_radius = document.getElementById('minumum_radius').value;
						document.getElementById('value_minumum_radius').innerHTML = value_minumum_radius;
					}
				</script>
			    <!-- <input type="text" class="form-control" name="minumum_radius" id="minumum_radius" style="width:400px; height:30px;"> -->

				<span class="input-group-addon" style="font-size:20px; white-space:nowrap;">Maximum Radius (0~100)</span>
				<input type="range" min="0" max="100" step="0.01" name="maximum_radius" id="maximum_radius" style="width:400px; height:20px;" oninput="change_maximum_radius()" onchange="change_maximum_radius()"/>
			    <span id="value_maximum_radius" style="font-size:20px">0</span>
				<script type='text/javascript'>
					function change_maximum_radius() {
					    var value_maximum_radius = document.getElementById('maximum_radius').value;
						document.getElementById('value_maximum_radius').innerHTML = value_maximum_radius;
					}
				</script>
			    <!-- <input type="text" class="form-control" name="maximum_radius" id="maximum_radius" style="width:400px; height:30px;"> -->

        <form class="form-horizontal" role="form">
            <div id="btn">
                <div class="col-sm-3"></div>
                <div class="input-group">
					<span class="input-group-addon" style="font-size:15px; white-space:nowrap;">Click "Generate!" bottom to proceed. Check the result below in 5 minutes. (Do NOT refresh!)</span>
					<span class="input-group-btn">

                        <!-- <button id="btn_submit" type="button" class="btn btn-default" onclick="getInputs()"> -->
						<button id="btn_submit" type="button" class="btn btn-default" onclick="getInputs()">
                            <span class="glyphicon glyphicon-asterisk"></span>
                            Generate!
                        </button>

						<button id="btn_setdefault" type="button" class="btn btn-default" onclick="download_stl()">
                            <span class="glyphicon glyphicon-asterisk"></span>
                            Download STL Model
                        </button>
						<script type='text/javascript'>
							function download_stl() {
								window. open('../ghBackend/media/Default/output.stl')
							}
						</script>

						<button id="btn_setdefault" type="button" class="btn btn-default" onclick="set_default()">
                            <span class="glyphicon glyphicon-asterisk"></span>
                            Get Default Settings
                        </button>
						<script type='text/javascript'>
							function set_default() {
								document.getElementById("reduce_rate").value = 0.5;
								document.getElementById('value_reduce_rate').innerHTML = 0.5;
								document.getElementById("tolerance_of_edge_length").value = 0.3;
								document.getElementById('value_tolerance_of_edge_length').innerHTML = 0.3;
								document.getElementById("length_constraint_maltiplier").value = 0.5;
								document.getElementById('value_length_constraint_maltiplier').innerHTML = 0.5;
								document.getElementById("boundary_constraint_magnitude").value = 5;
								document.getElementById('value_boundary_constraint_magnitude').innerHTML = 5;
								document.getElementById("perp_steps").value = 10000;
								document.getElementById('value_perp_steps').innerHTML = 10000;
								document.getElementById("minumum_radius").value = 1;
								document.getElementById('value_minumum_radius').innerHTML = 1;
								document.getElementById("maximum_radius").value = 10;
								document.getElementById('value_maximum_radius').innerHTML = 10;
								circles[0].x=50;
								circles[0].y=50;
								points[0].x=50;
								points[0].y=50;
								circles[1].x=450;
								circles[1].y=250;
								points[1].x=450;
								points[1].y=250;
								circles[2].x=450;
								circles[2].y=350;
								points[2].x=450;
								points[2].y=350;
								circles[3].x=200;
								circles[3].y=225;
								points[3].x=200;
								points[3].y=225;
								circles[4].x=50;
								circles[4].y=200;
								points[4].x=50;
								points[4].y=200;
								const canvas = document.getElementById('canvas');
								const context = canvas.getContext('2d');
								context.clearRect(0,0,canvas.width,canvas.height);
								for(var i=0; i<circles.length; i++) {
									var circle = circles[i];
									context.globalAlpha = 0.85;
									context.beginPath();
									context.arc(circle.x, circle.y, circle.radius, 0, Math.PI*2);
									context.fillStyle = circle.color;
									context.strokeStyle = "black";
									context.fill();
									context.stroke();
								}
								context.beginPath();
								context.moveTo(points[0].x,points[0].y);
								for (var i = 0; i < points.length; i++) {
									context.lineTo(points[i].x, points[i].y);
								}
								context.lineTo(points[0].x,points[0].y);
								context.fillStyle="rgb(128,128,128)";
								context.fill();
								context.strokeStyle="#black";
								context.stroke();
							}
						</script>
                    </span>
                </div>
            </div>
            <div id="list">
                <!-- js动态新增 -->
            </div>
        </form>
    </div>
	
	<div style="background-color: white; width: 100%; height: 400pt;"></div>
	
	<script>

		var content;
		var textfile;
		let arr;
		let arr0;
		//线段的点的集合
		var points=[];
		//可拖动圆圈的点的集合
		var circles=[];
		if (window.XMLHttpRequest)
		{ 
			textfile = new XMLHttpRequest(); 
		}
		textfile.onreadystatechange = function ()
		{   
			if (textfile.readyState == 4 && textfile.status == 200)
			{ 
				content = textfile.responseText;
				arr = content.split('\r\n');
				// document.getElementById("reduce_rate").defaultValue = "0.5";
				// document.getElementById("tolerance_of_edge_length").defaultValue = "0.3";
				// document.getElementById("length_constraint_maltiplier").defaultValue = "0.5";
				// document.getElementById("boundary_constraint_magnitude").defaultValue = "5";
				// document.getElementById("perp_steps").defaultValue = "10000";
				// document.getElementById("minumum_radius").defaultValue = "1";
				// document.getElementById("maximum_radius").defaultValue = "10";
				document.getElementById("reduce_rate").defaultValue = arr[1];
				document.getElementById('value_reduce_rate').innerHTML = arr[1];
				document.getElementById("tolerance_of_edge_length").defaultValue = arr[2];
				document.getElementById('value_tolerance_of_edge_length').innerHTML = arr[2];
				document.getElementById("length_constraint_maltiplier").defaultValue = arr[3];
				document.getElementById('value_length_constraint_maltiplier').innerHTML = arr[3];
				document.getElementById("boundary_constraint_magnitude").defaultValue = arr[4];
				document.getElementById('value_boundary_constraint_magnitude').innerHTML = arr[4];
				document.getElementById("perp_steps").defaultValue = arr[5];
				document.getElementById('value_perp_steps').innerHTML = arr[5];
				document.getElementById("minumum_radius").defaultValue = arr[6];
				document.getElementById('value_minumum_radius').innerHTML = arr[6];
				document.getElementById("maximum_radius").defaultValue = arr[7];
				document.getElementById('value_maximum_radius').innerHTML = arr[7];
				arr0 = arr[0].split(', ');
				arr0[0] = arr0[0].split('[')[1];
				arr0[arr0.length-1] = arr0[arr0.length-1].split(']')[0];
				console.log(arr0);
				//每一个点的对象
				// var point=new Point(50,50);
				// points.push(point);
				// var point=new Point(450,250);
				// points.push(point);
				// var point=new Point(450,350);
				// points.push(point);
				// var point=new Point(200,225);
				// points.push(point);
				// var point=new Point(50,200);
				// points.push(point);
				// var circle=new Circle(50,50);
				// circles.push(circle);
				// var circle=new Circle(450,250);
				// circles.push(circle);
				// var circle=new Circle(450,350);
				// circles.push(circle);
				// var circle=new Circle(200,225);
				// circles.push(circle);
				// var circle=new Circle(50,200);
				// circles.push(circle);
				var point=new Point(arr0[0]-0,500-arr0[1]);
				points.push(point);
				var point=new Point(arr0[2]-0,500-arr0[3]);
				points.push(point);
				var point=new Point(arr0[4]-0,500-arr0[5]);
				points.push(point);
				var point=new Point(arr0[6]-0,500-arr0[7]);
				points.push(point);
				var point=new Point(arr0[8]-0,500-arr0[9]);
				points.push(point);
				var circle=new Circle(arr0[0]-0,500-arr0[1]);
				circles.push(circle);
				var circle=new Circle(arr0[2]-0,500-arr0[3]);
				circles.push(circle);
				var circle=new Circle(arr0[4]-0,500-arr0[5]);
				circles.push(circle);
				var circle=new Circle(arr0[6]-0,500-arr0[7]);
				circles.push(circle);
				var circle=new Circle(arr0[8]-0,500-arr0[9]);
				circles.push(circle);

				const canvas = document.getElementById('canvas');
				const context = canvas.getContext('2d');

				var isDragging=false
				function Point(x, y) {
				this.x = x;
				this.y = y;
				}
				//圆圈对象
				function Circle(x, y) {
				this.x = x;
				this.y = y;
				this.radius = 10;
				this.color = "blue";
				//拖拽点的标记
				this.isSelected = false;
				}

				//进入下面的代码，绘制点
				context.clearRect(0,0,canvas.width,canvas.height);
				//遍历数组画圆
				circles[0].color="blue";
				for(var i=0; i<circles.length; i++) {
				var circle = circles[i];
				// 绘制圆圈
				context.globalAlpha = 0.85;
				context.beginPath();
				context.arc(circle.x, circle.y, circle.radius, 0, Math.PI*2);
				context.fillStyle = circle.color;
				context.strokeStyle = "black";
				context.fill();
				context.stroke();
				}
				// 画线
				context.beginPath();
				context.lineWidth = 4;
				//从起始点开始绘制
				context.moveTo(points[0].x,points[0].y);
				for (var i = 0; i < points.length; i++) {
				context.lineTo(points[i].x, points[i].y);
				}
				context.lineTo(points[0].x, points[0].y);
				context.fillStyle="rgb(128,128,128)";
				context.fill();
				context.strokeStyle="black";
				context.stroke();

				canvas.onmousedown=function(e){
				var clickX = e.pageX - canvas.offsetLeft;
				var clickY = e.pageY - canvas.offsetTop;
				//判断当前点击点是否在已经绘制的圆圈上，如果是执行相关操作，并return，不进入画线的代码
				for(var i=0; i<circles.length; i++) {
					var circle = circles[i];
					//使用勾股定理计算这个点与圆心之间的距离
					var distanceFromCenter = Math.sqrt(Math.pow(circle.x - clickX, 2) + Math.pow(circle.y - clickY, 2));
					// 如果是其他的点，则设置可以拖动
					if (distanceFromCenter <= circle.radius) {
						// 清除之前选择的圆圈
						index=i;
						isDragging=true;
						//停止搜索
						return;
					}
				}
				};

				canvas.onmousemove=function(e){
				// 判断圆圈是否开始拖拽
				if (isDragging == true) {
					// 判断拖拽对象是否存在
					// 取得鼠标位置
					var x1 = e.pageX - canvas.offsetLeft;
					var y1 = e.pageY - canvas.offsetTop;
					context.clearRect(0,0,canvas.width,canvas.height);
					//根据上文得到的index设置index点位置随鼠标改变
					circles[index].x=x1;
					circles[index].y=y1;
					points[index].x=x1;
					points[index].y=y1;
					for(var i=0; i<circles.length; i++) {
						var circle = circles[i];
						// 绘制圆圈
						context.globalAlpha = 0.85;
						context.beginPath();
						context.arc(circle.x, circle.y, circle.radius, 0, Math.PI*2);
						context.fillStyle = circle.color;
						context.strokeStyle = "black";
						context.fill();
						context.stroke();
					}
					context.beginPath();
					context.moveTo(points[0].x,points[0].y);
					for (var i = 0; i < points.length; i++) {
						context.lineTo(points[i].x, points[i].y);
					}
					context.lineTo(points[0].x,points[0].y);
					context.fillStyle="rgb(128,128,128)";
					context.fill();
					context.strokeStyle="#black";
					context.stroke();
				}
				};

				canvas.onmouseup=function(){
				isDragging=false;
				};

				canvas.onmouseout=function(){
				isDragging=false;
				};
			}
		}
		textfile.open("GET", '/ghBackend/media/Default/input.txt', true);
		textfile.send();

	</script>

	<body onload="draw();"></body>
	<script src="lib/three.js"></script>
	<script src="lib/js/loaders/STLLoader.js"></script>
	<script src="lib/js/controls/OrbitControls.js"></script>
	<script src="lib/js/libs/stats.min.js"></script>
	<script src="lib/js/libs/dat.gui.min.js"></script>

	<script>
		// var fp = 'Default/output.stl';
		var renderer;
		function initRender() {
			renderer = new THREE.WebGLRenderer({antialias:true});
			renderer.setSize(1000, 350);
			//告诉渲染器需要阴影效果
			renderer.setClearColor(0xE3E3E3);
			document.body.appendChild(renderer.domElement);
		}

		var camera;
		function initCamera() {
			camera = new THREE.PerspectiveCamera(45, 1000/350, 0.1, 1000);
			camera.position.set(0, 80, 100);
			camera.lookAt(new THREE.Vector3(0,0,0));
		}

		var scene;
		function initScene() {
			scene = new THREE.Scene();
		}

		//初始化dat.GUI简化试验流程
		var gui;
		function initGui() {
			//声明一个保存需求修改的相关数据的对象
			gui = {
			};
			var datGui = new dat.GUI();
			//将设置属性添加到gui当中，gui.add(对象，属性，最小值，最大值）
		}

		var light;
		function initLight() {
			scene.add(new THREE.AmbientLight(0x444444));

			light = new THREE.PointLight(0xffffff);
			light.position.set(0,50,50);

			//告诉平行光需要开启阴影投射
			light.castShadow = true;

			scene.add(light);
		}

		function initModel() {

			//辅助工具
			var helper = new THREE.AxesHelper(50);
			scene.add(helper);

			var loader = new THREE.STLLoader();
			// loader.load("AIStructureGenerator_User_EFC_APW_Web_output.stl", function (geometry) {
			loader.load('../ghBackend/media/Default/output.stl', function (geometry) {
				//创建纹理
				var mat = new THREE.MeshLambertMaterial({color: 0x0079ED});
				var mesh = new THREE.Mesh(geometry, mat);
				mesh.rotation.x = -0.5 * Math.PI; //将模型摆正
				mesh.scale.set(0.07, 0.07, 0.07); //缩放
				geometry.center(); //居中显示
				scene.add(mesh);
			});
		}

		//初始化性能插件
		var stats;
		function initStats() {
			stats = new Stats();
			//document.body.appendChild(stats.dom);
		}

		//用户交互插件 鼠标左键按住旋转，右键按住平移，滚轮缩放
		var controls;
		function initControls() {

			controls = new THREE.OrbitControls( camera, renderer.domElement );

			// 如果使用animate方法时，将此函数删除
			//controls.addEventListener( 'change', render );
			// 使动画循环使用时阻尼或自转 意思是否有惯性
			controls.enableDamping = false;
			//动态阻尼系数 就是鼠标拖拽旋转灵敏度
			controls.dampingFactor = 0.1;
			//是否可以缩放
			controls.enableZoom = true;
			//是否自动旋转
			controls.autoRotate = false;
			controls.autoRotateSpeed = 0.5;
			//设置相机距离原点的最远距离
			controls.minDistance  = 1;
			//设置相机距离原点的最远距离
			controls.maxDistance  = 200;
			//是否开启右键拖拽
			controls.enablePan = true;
		}

		function render() {

			renderer.render( scene, camera );
		}

		//窗口变动触发的函数
		function onWindowResize() {

			camera.aspect = 1000 / 350;
			camera.updateProjectionMatrix();
			render();
			renderer.setSize( 1000, 350 );

		}

		function animate() {
			//更新控制器
			render();

			//更新性能插件
			stats.update();

			controls.update();

			requestAnimationFrame(animate);
		}

		function draw() {
			initGui();
			initRender();
			initScene();
			initCamera();
			initLight();
			initModel();
			initControls();
			initStats();

			animate();
			window.onresize = onWindowResize;
		}
	</script>
</body>
</html>